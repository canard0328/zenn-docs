---
title: "SQLの備忘録"
emoji: "📝"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["SQL"]
published: false
---

SQLを一から学んでいく備忘録です。
[スッキリわかるSQL入門](https://amzn.to/3HL5ibI)を参考にしています。

# 特定列の抽出

```sql
SELECT カラム名
FROM テーブル名
```

## 複数列の抽出

```sql
SELECT カラム１, カラム２, カラム３
FROM テーブル名
```

## 全列の抽出

＊による全列抽出は便利だが、DBの設計変更などで列が変更されたときに予期しない動作となる恐れがあるので、できれば使わない方がよい。

```sql
SELECT *
FROM テーブル名
```

## 条件に一致する行の抽出

SQLの「等しくない」は「＜＞」、  
NULLの判定は、「IS NULL」、「IS NOT NULL」を使います。

```sql
SELECT カラム１, カラム２, カラム３
FROM テーブル名
WHERE カラム３ > 3000
```

## 複数の条件を指定

```sql
SELECT カラム１, カラム２, カラム３
FROM テーブル名
WHERE (カラム３ > 3000 AND カラム３ < 5000)
OR カラム２ != 0
```

## 重複の削除

```sql
SELECT DISTINCT カラム１
FROM テーブル名
```

## 抽出結果の並び替え

DESCは降順、ASCは昇順です。何も書かなければ昇順（ASC）になります。  
NULLは最大値の次になるようです。

``` sql
SELECT *
FROM テーブル名
ORDER BY カラム１ DESC, カラム３ ASC
```

### 並び替え列の番号指定

並び替え基準列は列番号（１始まり）でも指定可能です。このとき、指定する列番号は元のテーブルの列番号ではなく、SELECTした結果に対応する番号であることに注意が必要です。

```sql
SELECT カラム３, カラム２, カラム５
FROM テーブル名
ORDER BY 2 ASC, 1 DESC
```

## 集合演算子UNIONにより2つのSELECT文の結果を足し合わせる

選択したリストの列数とデータ型は一致していなければなりません。  
UNIONは重複行を削除します。重複行を残す場合は、UNION ALLとします。

```sql
SELECT カラム１, カラム２, カラム３ FROM テーブル１
UNION
SELECT カラム１、カラム２、カラム３ FROM テーブル２
ORDER BY 2, 3, 1
```

## 選択列に計算式を用いる

SELECT文に式（カラム２*1.03など）や値（'hoge'）などを記載し、新たな列を生成することができます。  
新たに生成した列の列名を指定したい場合はAS句を用います。

```sql
SELECT カラム１,
       カラム２ * 1.03 AS 新カラム名２
       'hoge' AS 新カラム名２
FROM テーブル名
```

## CASE演算子の利用

下のSQL文では、「テーブル名」というテーブルから、カラム２が0より大きい行を対象に、カラム１とカラム２を選択し、
さらに、カラム１が'hoge'のときは'foo'、'fuga'のときは'bar'、それ以外は'hehe'となる新しいカラム「新カラム」を作成します。

```sql
SELECT カラム１, カラム２,
       CASE カラム１ WHEN 'hoge' THEN 'foo'
                    WHEN 'fuga' THEN 'bar'
                    ELSE 'hehe'
       END AS 新カラム
FROM テーブル名 WHERE カラム２ > 0
```

下のように、CASEのあとに評価する列や式がこない場合もあります。

```sql
SELECT カラム１, カラム２,
       CASE WHEN カラム２ < 1000 THEN 'foo'
            WHEN カラム２ < 5000 THEN 'bar'
            ELSE 'hehe'
       END AS 新カラム
FROM テーブル名 WHERE カラム２ > 0
```

# テーブルにデータ（行）を挿入

文字列や日付はシングルクォーテーションで囲みます。ダブルクォーテーションではありません。文字列内にシングルクォーテーションを含む場合は、シングルクォーテーションを2連続で記載するとエスケープできます。  
指定していないカラムには何も値が入りません。全カラムに値を入れる場合は2行目は省略可能です。2行目が省略されているのにVALUESの数が足りない場合、左の列から順に値が格納されていきます。

```sql
INSERT INTO テーブル名
(カラム１, カラム２, カラム３, カラム４)
VALUES ('hoge', 'foo', 123, 456)
```

# データの修正

WHEREを忘れると全行の値が置き換わってしまうため注意。

```sql
UPDATE テーブル名
SET カラム３ = 999
WHERE カラム１ = 'hoge'
```

## UPDATE文で計算式を用いる

以下のようにSET句に計算式を用いるとカラム３の列の値を全て＋１００できる。

```sql
UPDATE テーブル名
SET カラム３ = カラム３ + 100
```

# データ（行）の削除

```sql
DELETE FROM テーブル名
WHERE カラム１ = 'hoge'
```

# コメント

```sql
-- ハイフン2つから行末まではコメントとなります。
/*
また、／＊　＊／で囲んだ中もコメントになります。
*/
```

# 大文字と小文字

SELECTやWHEREなどの予約語（keyword）は大文字小文字を区別しません。  
列名やテーブル名で大文字小文字を区別するかはSQLでは未定義で、製品やOS、設定により異なります。

# ASによる別名の定義

多くのDBMSではASを省略できる。またOracle DBではテーブルに別名をつけるときにはASは記述してはいけない。

```sql
SELECT カラム１ AS COLUMN1, カラム９ AS COLUMN2
FROM テーブル名 AS NEWTABLE
WHERE カラム１ = 'hoge'
```

# LIKE演算子によるパターンマッチング

条件に一致する文字列を含む列を抽出したい場合、LIKE演算子を用います。％は「任意の０文字以上の文字列」を表します。任意の一字の文字は「＿」（アンダーバー）で表します。

```sql
SELECT *
FROM テーブル名
WHERE カラム１ LIKE '%foo%'
```

％や＿などの文字列自体を検索したい場合は、エスケープ文字を使います。エスケープ文字はESCAPE句で指定します。
下の例では「100%」という文字列を検索するために、＄をエスケープ文字として使用しています。

```sql
SELECT *
FROM テーブル名
WHERE カラム１ LIKE '%100$%' ESCAPE '$'
```

# BETWEEN演算子による範囲指定

範囲は以上と以下であり、境界値を含むことに注意が必要です。  
比較演算子と論理演算子ANDを組合せても同じことができますが、可読性が上がることがあります。速度についてはケースバイケースのようです。

```sql
SELECT *
FROM テーブル名
WHERE カラム１ BETWEEN 100 AND 1000
```

# IN／NOT IN演算子による複数値との比較

```sql
SELECT *
FROM テーブル名
WHERE カラム１ IN ('foo', 'bar')
```

# ANY／ALL演算子による複数値との比較

ANYやALLはDBMSによっては下の例のようにサブクエリでしか使えないことがある。  
下の例では、カラム２にhogeという文字列を含む行のカラム１の値のいずれかにマッチする行が選択される。
ANYをALLにすれば、いずれかではなく全ての条件にマッチする行が選択される（この例の場合マッチすることはないが）。

```sql
SELECT *
FROM テーブル名
WHERE カラム１ = ANY
    (SELECT カラム１ FROM テーブル名 WHERE カラム２ LIKE '%hoge%')
```

# 主キー

全く同じ情報の行が複数存在しないように、テーブルは、NULLを許容せず、行を一意に特定でき列、主キー（primary key）を持つべきである。  
社員番号のように、基から主キーの役割を果たせる列のことを自然キー（natural key）と呼ぶ。
自然キーが存在しない場合、連番などを振って主キーを人為的に作成する。このような列を人工キー（artifical key）や代替キー（surrogate key）と呼ぶ。  
主キーとなる1つの列が存在しなくても、複数列を組み合わせることで行を一意に特定できるとき、この複数列を1つの主キーとして扱うものを複合キー（compound key）という。

